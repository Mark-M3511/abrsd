<?php

/**
 * @file abrsd_user_registration.module
 * This module is used to create/update a custom user registration form.
 */


use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\webform\Entity\WebformSubmission;
use Drupal\Core\Form\FormStateInterface;
use Drupal\abrsd_user_registration\Plugin\WebformHandler\UserRegistration;
use Drupal\user\Entity\User;
use Drupal\file\Entity\File;
use Drupal\image\Entity\ImageStyle;

/**
 * Implements hook_help().
 * @param string $route_name
 * @param RouteMatchInterface $route_match
 * @return string
 */
function abrsd_user_registration_help($route_name, RouteMatchInterface $route_match)
{
    $help = '';
    switch ($route_name) {
            // Main module help for the abrsd_user_registration module.
        case 'help.page.abrsd_user_registration':
            $help .= '<p>' . t('This module is used to create/update a custom user registration form.') . '</p>';
            break;

            // Module-specific help for another route.
        case 'abrsd_user_registration.some_route':
            $help .= '<p>' . t('Description of some feature of the abrsd_user_registration module.') . '</p>';
            break;
        default:
            break;
    }
    return $help;
}


/**
 * Implements hook_form_alter().
 *
 * Alters the form elements and form state for the 'webform_submission_user_profile_add_form' form.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state object.
 * @param string $form_id
 *   The ID of the form being altered.
 */
function abrsd_user_registration_form_alter(&$form, FormStateInterface &$form_state, $form_id)
{
    try {
        if (!empty($form['#webform_id']) && ($form['#webform_id'] == 'user_profile')) {
            $form['#attached']['library'][] = 'abrsd_user_registration/abrsd_user_registration';
            // Load the logged in user
            $user = User::load(\Drupal::currentUser()->id());
            // $user = User::load(14);
            if (!empty($user)) {
                // Load the custom UserRegistration service
                $sid = UserRegistration::getSubmissionId($user->id());
                // Load the profile form values
                _abrsd_user_registration_load_profile_form_values($form['elements'], $form_state, $sid, $user);
            }
        }
    } catch (\Exception $e) {
        // Log any errors
        \Drupal::logger('abrsd_user_registration')->error($e->getMessage());
    }
}

/**
 * Loads the profile form values for a user registration.
 *
 * This function is responsible for loading the default values for the profile form
 * elements based on the submission data retrieved from a webform entity.
 *
 * @param array &$form_elements
 *   The array of form elements.
 * @param FormStateInterface &$form_state
 *   The form state object.
 * @param int|null $sid
 *   The submission ID.
 * @param User $user
 *   The user object.
 *
 * @throws \Exception
 *   If an error occurs during the process.
 */
function _abrsd_user_registration_load_profile_form_values(
    array &$form_elements,
    FormStateInterface &$form_state,
    ?int $sid,
    User $user
) {
    try {
        if (!empty($sid)) {
            // Load the submission from the webform entity
            $submission = WebformSubmission::load($sid);
            // Element data
            $submission_data = $submission->getData();
            // Add first name
            $form_elements['first_name']['#default_value'] = $submission_data['first_name'] ?? $user->field_first_name->value;
            // Add last name
            $form_elements['last_name']['#default_value'] = $submission_data['last_name'] ?? $user->field_last_name->value;
            // Add country
            $form_elements['country']['#default_value'] = $submission_data['country'] ?? $user->field_country->value;
            // Add email
            $form_elements['signup_email']['#default_value'] = $submission_data['signup_email'] ?? $user->getEmail();
            // Add organization
            $form_elements['organization']['#default_value'] = $submission_data['organization'] ?? $user->field_organization->value;
            // Add interests
            $form_elements['interests']['#default_value'] = $submission_data['interests'] ?? $user->field_interests->value;
            // Add about_me
            $form_elements['about_me']['#default_value'] = $submission_data['about_me'] ?? $user->field_about_me->value;
            // Add display name
            $form_elements['display_name']['#default_value'] = $submission_data['display_name'] ?? $user->field_display_name->value;
            // Check if the profile picture has been removed
            $user_pic_removed = _abrsd_user_registration_user_picture_removed($form_state);
            // If the profile picture is not empty add the profile picture display
            if (!empty($submission_data['profile_picture'])) {
                // Add the profile picture
                $form_elements['profile_picture']['#default_value'] = [$submission_data['profile_picture']];
                // Add the webform submission ID
                $file_url = _abrsd_user_registration_user_picture($user);
                // Add the profile picture display if $file_url is not null
                if (!empty($file_url)) {
                    $form_elements['profile_picture_display'] = [
                        '#type' => 'inline_template',
                        '#template' => '<img src="{{ url }}" class="{{ css_class }}" alt="Profile picture" />',
                        '#context' => [
                            'url' => $file_url,
                            'css_class' => $user_pic_removed ? 'hidden' : '',
                        ],
                        '#weight' => 0,
                        // '#access' => $user_pic_removed ? FALSE : TRUE,
                        '#prefix' => '<div id="profile-picture-display">',
                        '#suffix' => '</div>',
                    ];
                }
            }
        }
    } catch (\Exception $e) {
        // Log any errors
        \Drupal::logger('abrsd_user_registration')->error($e->getMessage());
    }
}

/**
 * Get the user picture.
 *
 * @param int $uid
 *   The user ID.
 *
 * @return string|null
 *   The URL of the user picture if found, NULL otherwise.
 */
function _abrsd_user_registration_user_picture(User $user): ?string
{
    $result = NULL;
    try {
        // Get the file ID of the user picture
        $fid = $user->get('user_picture')->target_id;
        // Load the file entity
        if (!empty($fid)) {
            $file = File::load($fid);
            if ($file) {
                // Get the URL of the image with the desired style.
                $result = ImageStyle::load('thumbnail')->buildUrl($file->getFileUri());
            }
        }
    } catch (\Exception $e) {
        // Log any errors
        \Drupal::logger('abrsd_user_registration')->error($e->getMessage());
    }

    return $result;
}

/**
 * Checks if the user picture has been removed from the form.
 *
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state object.
 *
 * @return bool
 *   TRUE if the user picture has been removed, FALSE otherwise.
 */
function _abrsd_user_registration_user_picture_removed(FormStateInterface $form_state): bool
{
    $result = FALSE;
    try {
        // Check if the user picture has been removed
        $user_pic = $form_state->getValue('profile_picture');
        $result = is_array($user_pic) && !isset($user_pic['fid']);
    } catch (\Exception $e) {
        // Log any errors
        \Drupal::logger('abrsd_user_registration')->error($e->getMessage());
    }

    return $result;
}

/**
 * Implements hook_form_FORM_ID_alter() for the user form.
 *
 * This function is called when altering the user form. It checks if the current user has
 * the Comment Contributor role and hides certain fields based on that role.
 *
 * @param array &$form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface &$form_state
 *   The form state object.
 * @param string $form_id
 *   The form ID.
 *
 * @throws \Exception
 *   If an error occurs during the process.
 */
function abrsd_user_registration_form_user_form_alter(
    array &$form,
    FormStateInterface &$form_state,
    string $form_id
) {
    try {
        // Does the current user have the Comment Contributor role
        $user = User::load(\Drupal::currentUser()->id());
        if (!empty($user)) {
            $roles = $user->getRoles();
            if (in_array('comment_contributor', $roles)) {
                // Hide some fields provided by core
                $form['user_picture']['#access'] = FALSE;
                $form['language']['#access'] = FALSE;
                $form['timezone']['#access'] = FALSE;
                // Hide the contact field - this is a core form field set in the contact.module
                // See this projects .install file more information
                $form['contact']['#access'] = FALSE;
                // Hide custom fields
                $form['field_display_name']['#access'] = FALSE;
                $form['field_first_name']['#access'] = FALSE;
                $form['field_last_name']['#access'] = FALSE;
                $form['field_country']['#access'] = FALSE;
                $form['field_organization']['#access'] = FALSE;
                $form['field_about_me']['#access'] = FALSE;
                $form['field_interests']['#access'] = FALSE;
            }
        }
    } catch (\Exception $e) {
        \Drupal::logger('abrsd_user_registration')->error($e->getMessage());
    }
}
